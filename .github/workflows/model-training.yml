name: Diabetes MLflow CI/CD with Docker Hub

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'MLproject/**'
      - '.github/workflows/**'
      - '*.py'
      - '*.yaml'
      - '*.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      experiment_name:
        description: 'MLflow experiment name'
        required: false
        default: 'diabetes_classification_ci_[nama-siswa]'
      n_estimators:
        description: 'Number of estimators'
        required: false
        default: '100'
      max_depth:
        description: 'Maximum depth'
        required: false
        default: '10'
      build_docker:
        description: 'Build and push Docker image (true/false)'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  diabetes-model-training-and-docker:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Docker
      uses: docker/setup-buildx-action@v3
      with:
        install: true

    - name: Start Docker daemon
      run: |
        sudo systemctl start docker
        sudo systemctl enable docker
        sudo usermod -aG docker $USER
        # Verify Docker is running
        docker --version
        docker info

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy==1.24.4 pandas==2.1.4 scikit-learn==1.3.2 
        pip install matplotlib==3.8.2 seaborn==0.13.0
        pip install mlflow==2.8.1 dagshub python-dotenv joblib
        pip install requests urllib3
        
    - name: Setup environment variables
      run: |
        echo "PYTHONPATH=$GITHUB_WORKSPACE:$GITHUB_WORKSPACE/MLproject:$PYTHONPATH" >> $GITHUB_ENV
        echo "MLFLOW_TRACKING_INSECURE_TLS=true" >> $GITHUB_ENV
        echo "MLFLOW_HTTP_REQUEST_TIMEOUT=30" >> $GITHUB_ENV
        echo "MLFLOW_HTTP_REQUEST_MAX_RETRIES=3" >> $GITHUB_ENV
        
    - name: Prepare diabetes data and run training
      working-directory: ./MLproject
      run: |
        # Create sample diabetes data if needed
        python -c "
        import pandas as pd
        import numpy as np
        from sklearn.preprocessing import LabelEncoder
        import os
        
        if not os.path.exists('diabetes_preprocessed.csv'):
            # Create sample diabetes data
            np.random.seed(42)
            n_samples = 1000
            
            data = {
                'gender': np.random.choice(['Male', 'Female'], n_samples),
                'age': np.random.normal(50, 15, n_samples),
                'hypertension': np.random.choice([0, 1], n_samples, p=[0.8, 0.2]),
                'heart_disease': np.random.choice([0, 1], n_samples, p=[0.9, 0.1]),
                'smoking_history': np.random.choice(['never', 'former', 'current'], n_samples),
                'bmi': np.random.normal(25, 5, n_samples),
                'HbA1c_level': np.random.normal(5.5, 1, n_samples),
                'blood_glucose_level': np.random.normal(120, 30, n_samples),
                'diabetes': np.random.choice([0, 1], n_samples, p=[0.7, 0.3])
            }
            
            df = pd.DataFrame(data)
            
            # Basic preprocessing
            le_gender = LabelEncoder()
            le_smoking = LabelEncoder()
            df['gender'] = le_gender.fit_transform(df['gender'])
            df['smoking_history'] = le_smoking.fit_transform(df['smoking_history'])
            
            # Ensure positive values
            df['age'] = np.clip(df['age'], 18, 100)
            df['bmi'] = np.clip(df['bmi'], 15, 50)
            df['HbA1c_level'] = np.clip(df['HbA1c_level'], 3, 15)
            df['blood_glucose_level'] = np.clip(df['blood_glucose_level'], 50, 300)
            
            df.to_csv('diabetes_preprocessed.csv', index=False)
            print('Sample diabetes data created')
        "
        
        # Run training
        python modelling.py \
          --data_path "diabetes_preprocessed.csv" \
          --experiment_name "${{ github.event.inputs.experiment_name || 'diabetes_classification_ci_[nama-siswa]' }}" \
          --model_name "diabetes_classifier_ci" \
          --n_estimators ${{ github.event.inputs.n_estimators || 100 }} \
          --max_depth ${{ github.event.inputs.max_depth || 10 }} \
          --random_state 42
          
    - name: Login to Docker Hub
      if: github.event.inputs.build_docker != 'false'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
        
    - name: Build MLflow Docker Image for Diabetes
      if: github.event.inputs.build_docker != 'false'
      working-directory: ./MLproject
      run: |
        echo "ğŸ³ Building MLflow Docker image for diabetes classification..."
        
        # Check if model was trained successfully
        if [ -f "diabetes_model_ci.pkl" ]; then
          echo "âœ… Diabetes model found, proceeding with Docker build"
          
          # Create a simple MLmodel file for MLflow
          mkdir -p model
          cat > model/MLmodel << 'EOF'
        artifact_path: model
        flavors:
          python_function:
            env:
              conda: conda.yaml
              virtualenv: requirements.txt
            loader_module: mlflow.sklearn
            model_path: model.pkl
            predict_fn: predict
            python_version: 3.9.0
          sklearn:
            code: null
            pickled_model: model.pkl
            serialization_format: cloudpickle
            sklearn_version: 1.3.2
        model_uuid: $(python -c "import uuid; print(uuid.uuid4())")
        utc_time_created: '$(date -u +"%Y-%m-%d %H:%M:%S.%6N")'
        EOF
          
          # Copy model file
          cp diabetes_model_ci.pkl model/model.pkl
          
          # Build Docker image using MLflow
          DOCKER_IMAGE_NAME="${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow:latest"
          echo "Building Docker image: $DOCKER_IMAGE_NAME"
          
          # Try MLflow build first
          if mlflow models build-docker -m "./model" -n "$DOCKER_IMAGE_NAME" --enable-mlserver; then
            echo "âœ… MLflow Docker build successful"
          else
            echo "MLflow build-docker failed, using traditional Docker build..."
            
            # Create requirements.txt for Docker
            cat > requirements.txt << 'EOF'
        mlflow==2.8.1
        scikit-learn==1.3.2
        pandas==2.1.4
        numpy==1.24.4
        flask==2.3.3
        joblib
        EOF
            
            # Create health check script
            cat > health_check.py << 'EOF'
        from flask import Flask, jsonify
        import joblib
        import os
        
        app = Flask(__name__)
        
        @app.route('/health')
        def health():
            try:
                if os.path.exists('model.pkl'):
                    return jsonify({"status": "healthy", "model": "diabetes_classifier"})
                else:
                    return jsonify({"status": "unhealthy", "error": "model not found"}), 500
            except Exception as e:
                return jsonify({"status": "unhealthy", "error": str(e)}), 500
        
        @app.route('/predict', methods=['POST'])
        def predict():
            try:
                model = joblib.load('model.pkl')
                return jsonify({"status": "ready", "model_type": str(type(model))})
            except Exception as e:
                return jsonify({"error": str(e)}), 500
        
        if __name__ == '__main__':
            app.run(host='0.0.0.0', port=8080)
        EOF
            
            # Create Dockerfile
            cat > Dockerfile-model << 'EOF'
        FROM python:3.9-slim
        
        WORKDIR /app
        
        # Install system dependencies
        RUN apt-get update && apt-get install -y gcc && rm -rf /var/lib/apt/lists/*
        
        # Copy requirements and install
        COPY requirements.txt .
        RUN pip install --no-cache-dir -r requirements.txt
        
        # Copy model and application files
        COPY diabetes_model_ci.pkl model.pkl
        COPY modelling.py .
        COPY diabetes_preprocessed.csv .
        COPY health_check.py .
        
        # Expose port
        EXPOSE 8080
        
        # Start health check service
        CMD ["python", "health_check.py"]
        EOF
            
            # Build Docker image
            docker build -f Dockerfile-model -t "$DOCKER_IMAGE_NAME" .
            echo "âœ… Traditional Docker build successful"
          fi
          
          echo "âœ… Docker image built successfully: $DOCKER_IMAGE_NAME"
        else
          echo "âŒ Diabetes model not found, skipping Docker build"
          exit 1
        fi
        
    - name: Push Docker Image to Docker Hub
      if: github.event.inputs.build_docker != 'false'
      working-directory: ./MLproject
      run: |
        DOCKER_IMAGE_NAME="${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow:latest"
        echo "ğŸš€ Pushing Docker image to Docker Hub..."
        
        docker push "$DOCKER_IMAGE_NAME"
        
        echo "âœ… Docker image pushed successfully!"
        echo "ğŸ³ Docker Hub URL: https://hub.docker.com/r/${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow"
        
        # Tag with build number
        BUILD_TAG="${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow:build-${{ github.run_number }}"
        docker tag "$DOCKER_IMAGE_NAME" "$BUILD_TAG"
        docker push "$BUILD_TAG"
        
        echo "âœ… Also tagged as: $BUILD_TAG"
    
    - name: Test Docker Image Locally
      if: github.event.inputs.build_docker != 'false'
      run: |
        DOCKER_IMAGE_NAME="${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow:latest"
        echo "ğŸ§ª Testing Docker image locally..."
        
        # Run container in background
        docker run -d -p 8080:8080 --name test-diabetes-model "$DOCKER_IMAGE_NAME" || {
          echo "Failed to start container, checking logs..."
          docker logs test-diabetes-model || true
          echo "Container failed to start"
        }
        
        # Wait for container to start
        sleep 10
        
        # Check if container is running
        if docker ps | grep test-diabetes-model; then
          echo "âœ… Container is running successfully"
          
          # Test health endpoint
          curl -f http://localhost:8080/health || echo "Health check endpoint not available"
        else
          echo "âŒ Container failed to start"
          docker logs test-diabetes-model || true
        fi
        
        # Cleanup
        docker stop test-diabetes-model || true
        docker rm test-diabetes-model || true
        
    - name: Upload training artifacts
      uses: actions/upload-artifact@v4
      with:
        name: diabetes-model-artifacts-${{ github.run_number }}
        path: |
          MLproject/*.pkl
          MLproject/*.png
          MLproject/*.txt
          MLproject/*.md
          MLproject/*.csv
          MLproject/model_artifacts/
          MLproject/mlruns/
        retention-days: 30
        if-no-files-found: warn
        
    - name: Create comprehensive summary
      working-directory: ./MLproject
      run: |
        echo "# ğŸ¯ Diabetes MLflow CI/CD Training & Docker Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow Run**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Dataset**: Diabetes Classification" >> $GITHUB_STEP_SUMMARY
        echo "- **Parameters**: n_estimators=${{ github.event.inputs.n_estimators || 100 }}, max_depth=${{ github.event.inputs.max_depth || 10 }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Experiment**: ${{ github.event.inputs.experiment_name || 'diabetes_classification_ci_[nama-siswa]' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Build**: ${{ github.event.inputs.build_docker != 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: [nama-siswa]" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ³ Docker Information" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.build_docker }}" != "false" ]; then
          echo "- **Docker Hub Repository**: https://hub.docker.com/r/${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Tag**: \`${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Tag**: \`${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow:build-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Pull Command**: \`docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Command**: \`docker run -p 8080:8080 ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow:latest\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Docker build was skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "## ğŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -la *.pkl *.png *.txt *.md *.csv 2>/dev/null || echo "No artifacts found"
        echo '```' >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“Š Training Results" >> $GITHUB_STEP_SUMMARY
        if [ -f "diabetes_training_summary.md" ]; then
          cat diabetes_training_summary.md >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Notify completion
      run: |
        echo "ğŸ‰ Diabetes MLflow CI/CD with Docker workflow completed successfully!"
        echo "ğŸ“Š Check the 'Actions' tab for detailed results and artifacts"
        echo "ğŸ“ Artifacts will be available for download for 30 days"
        if [ "${{ github.event.inputs.build_docker }}" != "false" ]; then
          echo "ğŸ³ Docker image pushed to: https://hub.docker.com/r/${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow"
          echo "ğŸš€ Pull with: docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow:latest"
          echo "â–¶ï¸  Run with: docker run -p 8080:8080 ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-classification-mlflow:latest"
        fi
        echo "ğŸ’» Local tracking: MLflow results stored in artifacts"
        echo "ğŸ¥ Model: Diabetes Classification with Random Forest"